diff -ur man-1.5i.orig/src/makewhatis.sh man-1.5i/src/makewhatis.sh
--- man-1.5i.orig/src/makewhatis.sh	Mon Mar 19 19:15:24 2001
+++ man-1.5i/src/makewhatis.sh	Fri May 18 10:13:09 2001
@@ -3,6 +3,8 @@
 # Created: Sun Jun 14 10:49:37 1992
 # Revised: Sat Jan  8 14:12:37 1994 by faith@cs.unc.edu
 # Revised: Sat Mar 23 17:56:18 1996 by micheal@actrix.gen.nz
+# Revised: Thu Aug 10 02:17:50 2000 by solar@owl.openwall.com
+# Revised: Fri May 18 10:11:26 2001 by solar@owl.openwall.com
 # Copyright 1992, 1993, 1994 Rickard E. Faith (faith@cs.unc.edu)
 # May be freely distributed and modified as long as copyright is retained.
 #
@@ -25,6 +27,8 @@
 # 971012 - replaced "test -z" - it doesnt work on SunOS 4.1.3_U1.
 # 980710 - be more careful with TMPFILE
 # 000323 - do not change PATH, better treatment of catpages - Bryan Henderson
+# 000810 - solar: use mktemp, keep whatis files consistent while running.
+# 010518 - solar: /usr/share/man is optional
 #
 # Note for Slackware users: "makewhatis -v -w -c" will work.
 #
@@ -32,30 +36,22 @@
 
 program=`basename $0`
 
-DEFMANPATH=/usr/man:/usr/share/man
-DEFCATPATH=/usr/man/preformat:/usr/man:/usr/share/man
+DEFMANPATH=/usr/man
+DEFCATPATH=/usr/man/preformat:/usr/man
+
+if [ -d /usr/share/man ]; then
+	DEFMANPATH="${DEFMANPATH}:/usr/share/man"
+	DEFCATPATH="${DEFCATPATH}:/usr/share/man"
+fi
 
 # AWK=/usr/bin/gawk
 AWK=%gawk%
 
-# Find a place for our temporary files. If security is not a concern, use
-#	TMPFILE=/tmp/whatis$$; TMPFILEDIR=none
-# Of course makewhatis should only have the required permissions
-# (for reading and writing directories like /usr/man).
-# We try here to be careful (and avoid preconstructed symlinks)
-# in case makewhatis is run as root, by creating a subdirectory of /tmp.
-
-TMPFILEDIR=/tmp/whatis.tmp.dir.$$
-rm -rf TMPFILEDIR
-if ! mkdir -m 0700 $TMPFILEDIR; then
-    echo Could not create $TMPFILEDIR
-    exit 1;
-fi
-TMPFILE=$TMPFILEDIR/w
+test -n "$TMPDIR" || TMPDIR=/tmp
+TMPFILE=`mktemp $TMPDIR/$program.XXXXXX` || exit 1
 
-# make sure TMPFILEDIR is deleted if program is killed or terminates
-# (just delete this line if your shell doesnt know about trap)
-trap "rm -rf $TMPFILEDIR" 0 1 2 3 15
+# make sure TMPFILE is deleted if program is killed or terminates
+trap "rm -f $TMPFILE" EXIT HUP INT QUIT TERM
 
 topath=manpath
 
@@ -118,7 +114,7 @@
 fi
 catpath=`echo ${catpath} | tr : ' '`
 
-# first truncate all the whatis files that will be created new,
+# first mark all the whatis files that will be created new,
 # then only update - we might visit the same directory twice
 if [ x$update = x ]; then
    for pages in man cat
@@ -126,7 +122,7 @@
       eval path="\$$pages"path
       for mandir in $path
       do
-	 cp /dev/null $mandir/whatis
+	 touch $mandir/whatis.update
       done
    done
 fi
@@ -140,7 +136,7 @@
      if [ x$verbose != x ]; then
 	echo "about to enter $mandir" > /dev/tty
      fi
-     if [ -s ${mandir}/whatis -a $pages = man -a x$update = x ]; then
+     if [ ! -f ${mandir}/whatis.update -a $pages = man -a x$update = x ]; then
 	if [ x$verbose != x ]; then
 	   echo skipping $mandir - we did it already > /dev/tty
 	fi
@@ -358,14 +354,12 @@
        then
 	 cat ${mandir1}/whatis >> $TMPFILE
        fi
-       sed '/^$/d' < $TMPFILE | sort | uniq > ${mandir1}/whatis
+       touch ${mandir1}/whatis.tmp
+       chmod 644 ${mandir1}/whatis.tmp
+       sed '/^$/d' < $TMPFILE | sort -u > ${mandir1}/whatis.tmp
 
-       chmod 644 ${mandir1}/whatis
-       rm $TMPFILE
+       mv -f ${mandir1}/whatis.tmp ${mandir1}/whatis
+       rm ${mandir1}/whatis.update
      fi
    done
 done
-
-# remove tempdir
-rm -rf $TMPFILEDIR
-
