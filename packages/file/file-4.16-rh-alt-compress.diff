--- file-4.16/src/compress.c.orig	2005-03-09 19:02:50.000000000 +0000
+++ file-4.16/src/compress.c	2005-10-21 09:35:54.000000000 +0000
@@ -316,6 +316,7 @@
     const unsigned char *old, unsigned char **newch, size_t n)
 {
 	int fdin[2], fdout[2];
+	pid_t pid1 = -1, pid2 = -1;
 	int r;
 
 #ifdef HAVE_LIBZ
@@ -329,7 +330,7 @@
 		file_error(ms, errno, "cannot create pipe");	
 		return 0;
 	}
-	switch (fork()) {
+	switch ((pid1=fork())) {
 	case 0:	/* child */
 		(void) close(0);
 		if (fd != -1) {
@@ -370,7 +371,7 @@
 			 * fork again, to avoid blocking because both
 			 * pipes filled
 			 */
-			switch (fork()) {
+			switch ((pid2=fork())) {
 			case 0: /* child */
 				(void)close(fdout[0]);
 				if (swrite(fdin[1], old, n) != n) {
@@ -425,12 +426,8 @@
 		if (fdin[1] != -1)
 			(void) close(fdin[1]);
 		(void) close(fdout[0]);
-#ifdef WNOHANG
-		while (waitpid(-1, NULL, WNOHANG) != -1)
-			continue;
-#else
-		(void)wait(NULL);
-#endif
+		waitpid(pid1, NULL, 0);
+		waitpid(pid2, NULL, 0);
 		return n;
 	}
 }
