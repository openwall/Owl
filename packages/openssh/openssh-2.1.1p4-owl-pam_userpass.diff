diff -urN openssh-2.1.1p4.orig/Makefile.in openssh-2.1.1p4/Makefile.in
--- openssh-2.1.1p4.orig/Makefile.in	Tue Jul 11 15:34:34 2000
+++ openssh-2.1.1p4/Makefile.in	Fri Aug  4 06:47:19 2000
@@ -40,7 +40,7 @@
 
 SSHOBJS= ssh.o sshconnect.o sshconnect1.o sshconnect2.o log-client.o readconf.o clientloop.o
 
-SSHDOBJS= sshd.o auth.o auth1.o auth2.o auth-rhosts.o auth-options.o auth-krb4.o auth-pam.o auth-passwd.o auth-rsa.o auth-rh-rsa.o pty.o log-server.o login.o loginrec.o servconf.o serverloop.o md5crypt.o session.o
+SSHDOBJS= sshd.o auth.o auth1.o auth2.o auth-rhosts.o auth-options.o auth-krb4.o auth-pam.o appl_userpass.o auth-passwd.o auth-rsa.o auth-rh-rsa.o pty.o log-server.o login.o loginrec.o servconf.o serverloop.o md5crypt.o session.o
 
 TROFFMAN	= scp.1 ssh-add.1 ssh-agent.1 ssh-keygen.1 ssh.1 sshd.8
 CATMAN		= scp.0 ssh-add.0 ssh-agent.0 ssh-keygen.0 ssh.0 sshd.0
diff -urN openssh-2.1.1p4.orig/_pam_userpass.h openssh-2.1.1p4/_pam_userpass.h
--- openssh-2.1.1p4.orig/_pam_userpass.h	Thu Jan  1 03:00:00 1970
+++ openssh-2.1.1p4/_pam_userpass.h	Fri Aug  4 06:47:19 2000
@@ -0,0 +1,12 @@
+#ifndef __PAM_USERPASS_H
+#define __PAM_USERPASS_H
+
+#define USERPASS_AGENT_ID		"userpass"
+#define USERPASS_AGENT_ID_LENGTH	8
+
+#define USERPASS_USER_MASK		0x03
+#define USERPASS_USER_REQUIRED		1
+#define USERPASS_USER_KNOWN		2
+#define USERPASS_USER_FIXED		3
+
+#endif
diff -urN openssh-2.1.1p4.orig/appl_userpass.c openssh-2.1.1p4/appl_userpass.c
--- openssh-2.1.1p4.orig/appl_userpass.c	Thu Jan  1 03:00:00 1970
+++ openssh-2.1.1p4/appl_userpass.c	Fri Aug  4 06:47:19 2000
@@ -0,0 +1,51 @@
+#include <string.h>
+#include <stdlib.h>
+
+#include <security/pam_appl.h>
+#include <security/pam_client.h>
+
+#include "_pam_userpass.h"
+#include "pam_userpass.h"
+
+int pam_userpass_conv(int num_msg, const struct pam_message **msg,
+	struct pam_response **resp, void *appdata_ptr)
+{
+	pam_userpass_t *userpass = (pam_userpass_t *)appdata_ptr;
+	pamc_bp_t prompt;
+	char *data;
+	char flags;
+
+	if (num_msg != 1 || msg[0]->msg_style != PAM_BINARY_PROMPT)
+		return PAM_CONV_ERR;
+
+	prompt = (pamc_bp_t)msg[0]->msg;
+	data = PAM_BP_DATA(prompt);
+
+	if (PAM_BP_CONTROL(prompt) != PAM_BPC_SELECT ||
+	    strncmp(data, USERPASS_AGENT_ID "/", USERPASS_AGENT_ID_LENGTH + 1))
+		return PAM_CONV_ERR;
+
+	flags = data[USERPASS_AGENT_ID_LENGTH + 1];
+	data += USERPASS_AGENT_ID_LENGTH + 1 + 1;
+
+	if ((flags & USERPASS_USER_MASK) == USERPASS_USER_FIXED &&
+	    strcmp(data, userpass->user))
+		return PAM_CONV_AGAIN;
+
+	if (!(*resp = malloc(sizeof(struct pam_response))))
+		return PAM_CONV_ERR;
+
+	prompt = NULL;
+	PAM_BP_RENEW(&prompt, PAM_BPC_DONE,
+		strlen(userpass->user) + 1 + strlen(userpass->pass));
+	data = PAM_BP_DATA(prompt);
+
+	strcpy(data, userpass->user);
+	data += strlen(data) + 1;
+	memcpy(data, userpass->pass, strlen(userpass->pass));
+
+	(*resp)[0].resp_retcode = 0;
+	(*resp)[0].resp = (char *)prompt;
+
+	return PAM_SUCCESS;
+}
diff -urN openssh-2.1.1p4.orig/auth-pam.c openssh-2.1.1p4/auth-pam.c
--- openssh-2.1.1p4.orig/auth-pam.c	Sun Jul  9 16:42:33 2000
+++ openssh-2.1.1p4/auth-pam.c	Fri Aug  4 06:47:19 2000
@@ -36,24 +36,29 @@
 
 RCSID("$Id: auth-pam.c,v 1.11 2000/07/09 12:42:33 djm Exp $");
 
+#include "pam_userpass.h"
+
 #define NEW_AUTHTOK_MSG \
 	"Warning: You password has expired, please change it now"
 
 /* Callbacks */
+#if 0
 static int pamconv(int num_msg, const struct pam_message **msg,
 	  struct pam_response **resp, void *appdata_ptr);
+#endif
 void pam_cleanup_proc(void *context);
 void pam_msg_cat(const char *msg);
 
 /* module-local variables */
+static pam_userpass_t userpass;
 static struct pam_conv conv = {
-	pamconv,
-	NULL
+	pam_userpass_conv,
+	&userpass
 };
 static struct pam_handle_t *pamh = NULL;
-static const char *pampasswd = NULL;
 static char *pam_msg = NULL;
 
+#if 0
 /* PAM conversation function. This is really a kludge to get the password */
 /* into PAM and to pick up any messages generated by PAM into pamconv_msg */
 static int pamconv(int num_msg, const struct pam_message **msg,
@@ -95,6 +100,7 @@
 
 	return PAM_SUCCESS;
 }
+#endif
 
 /* Called at exit to cleanly shutdown PAM */
 void pam_cleanup_proc(void *context)
@@ -137,7 +143,8 @@
 	if (*password == '\0' && options.permit_empty_passwd == 0)
 		return 0;
 
-	pampasswd = password;
+	userpass.user = pw->pw_name;
+	userpass.pass = password;
 	
 	pam_retval = pam_authenticate((pam_handle_t *)pamh, 0);
 	if (pam_retval == PAM_SUCCESS) {
diff -urN openssh-2.1.1p4.orig/pam_userpass.h openssh-2.1.1p4/pam_userpass.h
--- openssh-2.1.1p4.orig/pam_userpass.h	Thu Jan  1 03:00:00 1970
+++ openssh-2.1.1p4/pam_userpass.h	Fri Aug  4 06:47:19 2000
@@ -0,0 +1,14 @@
+#ifndef _PAM_USERPASS_H
+#define _PAM_USERPASS_H
+
+#include <security/pam_appl.h>
+
+typedef struct {
+	char *user;
+	char *pass;
+} pam_userpass_t;
+
+extern int pam_userpass_conv(int num_msg, const struct pam_message **msg,
+	struct pam_response **resp, void *appdata_ptr);
+
+#endif
