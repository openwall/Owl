diff -urp openssl-1.0.0i.orig/crypto/cms/cms_enc.c openssl-1.0.0i/crypto/cms/cms_enc.c
--- openssl-1.0.0i.orig/crypto/cms/cms_enc.c	2012-03-12 14:22:58 +0000
+++ openssl-1.0.0i/crypto/cms/cms_enc.c	2012-05-06 20:08:48 +0000
@@ -140,9 +140,9 @@ BIO *cms_EncryptedContent_init_bio(CMS_E
 		goto err;
 		}
 	/* Generate random session key */
-	if (!enc || !ec->key)
+	tkeylen = EVP_CIPHER_CTX_key_length(ctx);
+	if (!enc || !ec->key || ec->keylen != tkeylen)
 		{
-		tkeylen = EVP_CIPHER_CTX_key_length(ctx);
 		tkey = OPENSSL_malloc(tkeylen);
 		if (!tkey)
 			{
