--- texinfo-4.2/util/texindex.c.orig	Mon Mar 11 21:55:46 2002
+++ texinfo-4.2/util/texindex.c	Thu Jun 20 11:13:49 2002
@@ -20,6 +20,7 @@
 
 #include "system.h"
 #include <getopt.h>
+#include <stdlib.h>
 
 static char *program_name = "texindex";
 
@@ -37,8 +38,6 @@
 #define memset(ptr, ignore, count) bzero (ptr, count)
 #endif
 
-char *mktemp ();
-
 #if !defined (SEEK_SET)
 #  define SEEK_SET 0
 #  define SEEK_CUR 1
@@ -97,9 +96,6 @@
 /* Directory to use for temporary files.  On Unix, it ends with a slash.  */
 char *tempdir;
 
-/* Start of filename to use for temporary files.  */
-char *tempbase;
-
 /* Number of last temporary file.  */
 int tempcount;
 
@@ -138,6 +134,7 @@
 void *xmalloc (), *xrealloc ();
 char *concat ();
 void flush_tempfiles ();
+void flush_tempfiles_atexit ();
 
 #define MAX_IN_CORE_SORT 500000
 
@@ -181,8 +178,6 @@
 
   decode_command (argc, argv);
 
-  tempbase = mktemp (concat ("txiXXXXXX", "", ""));
-
   /* Process input files completely, one by one.  */
 
   for (i = 0; i < num_infiles; i++)
@@ -303,6 +298,8 @@
   int arg_index = 1;
   char **ip;
   char **op;
+  int retries;
+  char *dot;
 
   /* Store default values into parameter variables. */
 
@@ -316,8 +313,24 @@
   else
     tempdir = concat (tempdir, "/", "");
 
+  tempdir = concat(tempdir, "txi.XXXXXX", "");
+  retries = 0x1000;
+  do
+    {
+      if (mktemp (tempdir) == NULL || !tempdir[0])
+        fatal ("mktemp failed for %s", tempdir);
+      if (mkdir (tempdir, 0700) == 0) break;
+      if (errno != EEXIST || !--retries)
+        fatal ("mkdir: %s: %s", tempdir, strerror (errno));
+      if ((dot = strrchr (tempdir, '.')))
+        strcpy (dot, ".XXXXXX");
+    }
+  while (1);
+
   keep_tempfiles = 0;
 
+  atexit(flush_tempfiles_atexit);
+
   /* Allocate ARGC input files, which must be enough.  */
 
   infiles = (char **) xmalloc (argc * sizeof (char *));
@@ -388,8 +401,8 @@
      int count;
 {
   char tempsuffix[10];
-  sprintf (tempsuffix, ".%d", count);
-  return concat (tempdir, tempbase, tempsuffix);
+  sprintf (tempsuffix, "/%d", count);
+  return concat (tempdir, tempsuffix, "");
 }
 
 /* Delete all temporary files up to TO_COUNT. */
@@ -402,6 +415,13 @@
     return;
   while (last_deleted_tempcount < to_count)
     unlink (maketempname (++last_deleted_tempcount));
+  rmdir (tempdir);
+}
+
+void
+flush_tempfiles_atexit (void)
+{
+  flush_tempfiles (tempcount);
 }
 
 
@@ -942,7 +962,7 @@
   for (i = 0; i < ntemps; i++)
     {
       char *newtemp = maketempname (++tempcount);
-      sort_in_core (&tempfiles[i], MAX_IN_CORE_SORT, newtemp);
+      sort_in_core (tempfiles[i], MAX_IN_CORE_SORT, newtemp);
       if (!keep_tempfiles)
         unlink (tempfiles[i]);
       tempfiles[i] = newtemp;
@@ -1647,7 +1667,7 @@
   strcpy (result, s1);
   strcpy (result + len1, s2);
   strcpy (result + len1 + len2, s3);
-  *(result + len1 + len2 + len3) = 0;
+  result[len1 + len2 + len3] = '\0';
 
   return result;
 }
