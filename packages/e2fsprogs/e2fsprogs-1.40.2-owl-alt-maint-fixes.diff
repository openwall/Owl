 debugfs/debugfs.c       |    9 ++++++---
 doc/libext2fs.texinfo   |    6 ++----
 e2fsck/pass1.c          |    2 +-
 lib/blkid/blkid.pc.in   |    3 ++-
 lib/blkid/probe.c       |    9 +++++----
 lib/blkid/test_probe.in |    8 ++++----
 lib/et/com_err.texinfo  |    6 ++----
 lib/ext2fs/ismounted.c  |    6 ++----
 lib/ss/ss.pc.in         |    3 ++-
 misc/badblocks.c        |    2 +-
 misc/e2image.c          |    3 +--
 misc/util.c             |    4 ++--
 12 files changed, 30 insertions(+), 31 deletions(-)

diff --git a/debugfs/debugfs.c b/debugfs/debugfs.c
index 6635471..c7f2165 100644
--- a/debugfs/debugfs.c
+++ b/debugfs/debugfs.c
@@ -789,7 +789,8 @@ static void modify_u8(char *com, const char *prompt,
 
 	sprintf(buf, format, *val);
 	printf("%30s    [%s] ", prompt, buf);
-	fgets(buf, sizeof(buf), stdin);
+	if (!fgets(buf, sizeof(buf), stdin))
+		return;
 	if (buf[strlen (buf) - 1] == '\n')
 		buf[strlen (buf) - 1] = '\0';
 	if (!buf[0])
@@ -810,7 +811,8 @@ static void modify_u16(char *com, const char *prompt,
 
 	sprintf(buf, format, *val);
 	printf("%30s    [%s] ", prompt, buf);
-	fgets(buf, sizeof(buf), stdin);
+	if (!fgets(buf, sizeof(buf), stdin))
+		return;
 	if (buf[strlen (buf) - 1] == '\n')
 		buf[strlen (buf) - 1] = '\0';
 	if (!buf[0])
@@ -831,7 +833,8 @@ static void modify_u32(char *com, const char *prompt,
 
 	sprintf(buf, format, *val);
 	printf("%30s    [%s] ", prompt, buf);
-	fgets(buf, sizeof(buf), stdin);
+	if (!fgets(buf, sizeof(buf), stdin))
+		return;
 	if (buf[strlen (buf) - 1] == '\n')
 		buf[strlen (buf) - 1] = '\0';
 	if (!buf[0])
diff --git a/doc/libext2fs.texinfo b/doc/libext2fs.texinfo
index 1277c3a..82661d0 100644
--- a/doc/libext2fs.texinfo
+++ b/doc/libext2fs.texinfo
@@ -7,11 +7,9 @@
 
 @ifinfo
 @dircategory Development
-@format
-START-INFO-DIR-ENTRY
+@direntry
 * libext2fs: (libext2fs.info).                  The EXT2FS library.
-END-INFO-DIR-ENTRY
-@end format
+@end direntry
 @end ifinfo
 
 @c smallbook
diff --git a/e2fsck/pass1.c b/e2fsck/pass1.c
index b4db8ef..f8004c0 100644
--- a/e2fsck/pass1.c
+++ b/e2fsck/pass1.c
@@ -316,7 +316,7 @@ fix:
 
 	/* simple remove all possible EA(s) */
 	*((__u32 *)start) = 0UL;
-	e2fsck_write_inode_full(ctx, pctx->ino, (struct ext2_inode *) inode,
+	e2fsck_write_inode_full(ctx, pctx->ino, pctx->inode,
 				EXT2_INODE_SIZE(sb), "pass1");
 }
 
diff --git a/lib/blkid/blkid.pc.in b/lib/blkid/blkid.pc.in
index 510aa84..ff51782 100644
--- a/lib/blkid/blkid.pc.in
+++ b/lib/blkid/blkid.pc.in
@@ -8,4 +8,5 @@ Description: Block device id library
 Version: @E2FSPROGS_VERSION@
 Requires: uuid @DEVMAPPER_REQ@
 Cflags: -I${includedir} 
-Libs: -L${libdir} -lblkid @DEVMAPPER_PC_LIBS@
+Libs: -L${libdir} -lblkid
+Libs.private: @DEVMAPPER_PC_LIBS@
diff --git a/lib/blkid/probe.c b/lib/blkid/probe.c
index a188d82..615cc38 100644
--- a/lib/blkid/probe.c
+++ b/lib/blkid/probe.c
@@ -121,7 +121,7 @@ static int check_mdraid(int fd, unsigned char *ret_uuid)
 	return 0;
 }
 
-static void set_uuid(blkid_dev dev, uuid_t uuid, char *tag)
+static void set_uuid(blkid_dev dev, uuid_t uuid, const char *tag)
 {
 	char	str[37];
 
@@ -220,7 +220,7 @@ static int probe_jbd(struct blkid_probe *probe,
 #define FAT_ATTR_MASK			0x3f
 #define FAT_ENTRY_FREE			0xe5
 
-static char *no_name = "NO NAME    ";
+static const char *no_name = "NO NAME    ";
 
 static unsigned char *search_fat_label(struct vfat_dir_entry *dir, int count)
 {
@@ -582,10 +582,11 @@ static int probe_luks(struct blkid_probe *probe,
 		       struct blkid_magic *id __BLKID_ATTR((unused)),
 		       unsigned char *buf)
 {
-	unsigned char uuid[40];
+	char uuid[40];
+
 	/* 168 is the offset to the 40 character uuid:
 	 * http://luks.endorphin.org/LUKS-on-disk-format.pdf */
-	strncpy(uuid, buf+168, 40);
+	strncpy(uuid, (char *) buf+168, 40);
 	blkid_set_tag(probe->dev, "UUID", uuid, sizeof(uuid));
 	return 0;
 }
diff --git a/lib/blkid/test_probe.in b/lib/blkid/test_probe.in
index 02d42bb..ce8c42f 100644
--- a/lib/blkid/test_probe.in
+++ b/lib/blkid/test_probe.in
@@ -8,7 +8,7 @@ if test "$TESTS"x = x ; then
 	done
 fi
 
-mkdir -p tests
+mkdir -p tests/tmp
 
 for i in $TESTS
 do
@@ -19,9 +19,9 @@ do
 		echo "non-existent"
 		continue
 	fi
-	bunzip2 < $SRCDIR/tests/$i.img.bz2 > /tmp/test.img.$$
-	./tst_probe /tmp/test.img.$$ > tests/$i.out
-	/bin/rm -f /tmp/test.img.$$ tests/$i.ok tests/$i.failed
+	bunzip2 < $SRCDIR/tests/$i.img.bz2 > tests/tmp/test.img.$$
+	./tst_probe tests/tmp/test.img.$$ > tests/$i.out
+	/bin/rm -f tests/tmp/test.img.$$ tests/$i.ok tests/$i.failed
 	cmp -s tests/$i.out $SRCDIR/tests/$i.results
 	if [ $? = 0 ];  then
 		echo ok
diff --git a/lib/et/com_err.texinfo b/lib/et/com_err.texinfo
index def088c..7a00ffe 100644
--- a/lib/et/com_err.texinfo
+++ b/lib/et/com_err.texinfo
@@ -19,11 +19,9 @@
 
 @ifinfo
 @dircategory Development
-@format
-START-INFO-DIR-ENTRY
+@direntry
 * Com_err: (com_err).   A Common Error Description Library for UNIX.
-END-INFO-DIR-ENTRY
-@end format
+@end direntry
 @end ifinfo
 
 @iftex
diff --git a/lib/ext2fs/ismounted.c b/lib/ext2fs/ismounted.c
index 24246e0..cb563fd 100644
--- a/lib/ext2fs/ismounted.c
+++ b/lib/ext2fs/ismounted.c
@@ -251,10 +251,8 @@ static int is_swap_device(const char *file)
 	if (!(f = fopen("/proc/swaps", "r")))
 		return 0;
 	/* Skip the first line */
-	fgets(buf, sizeof(buf), f);
-	while (!feof(f)) {
-		if (!fgets(buf, sizeof(buf), f))
-			break;
+	if (fgets(buf, sizeof(buf), f))
+	while (fgets(buf, sizeof(buf), f)) {
 		if ((cp = strchr(buf, ' ')) != NULL)
 			*cp = 0;
 		if ((cp = strchr(buf, '\t')) != NULL)
diff --git a/lib/ss/ss.pc.in b/lib/ss/ss.pc.in
index 0218fd5..ce284fc 100644
--- a/lib/ss/ss.pc.in
+++ b/lib/ss/ss.pc.in
@@ -8,4 +8,5 @@ Description: Subsystem command parsing library
 Version: @E2FSPROGS_VERSION@
 Requires: com_err
 Cflags: -I${includedir} 
-Libs: -L${libdir} -lss @DLOPEN_LIB@
+Libs: -L${libdir} -lss
+Libs.private: @DLOPEN_LIB@
diff --git a/misc/badblocks.c b/misc/badblocks.c
index 88c5a74..29c5a5c 100644
--- a/misc/badblocks.c
+++ b/misc/badblocks.c
@@ -1012,7 +1012,7 @@ int main (int argc, char ** argv)
 		}
 	} else from_count = 0;
 	if (from_count >= last_block) {
-	    com_err (program_name, 0, _("invalid starting block (%d): must be less than %lu"),
+	    com_err (program_name, 0, _("invalid starting block (%lu): must be less than %lu"),
 		     (unsigned long) from_count, (unsigned long) last_block);
 	    exit (1);
 	}
diff --git a/misc/e2image.c b/misc/e2image.c
index dd13cea..5743075 100644
--- a/misc/e2image.c
+++ b/misc/e2image.c
@@ -126,8 +126,7 @@ static void write_image_file(ext2_filsys fs, int fd)
 	hdr.magic_number = EXT2_ET_MAGIC_E2IMAGE;
 	strcpy(hdr.magic_descriptor, "Ext2 Image 1.0");
 	gethostname(hdr.fs_hostname, sizeof(hdr.fs_hostname));
-	strncat(hdr.fs_device_name, device_name, sizeof(hdr.fs_device_name));
-	hdr.fs_device_name[sizeof(hdr.fs_device_name) - 1] = 0;
+	strncat(hdr.fs_device_name, device_name, sizeof(hdr.fs_device_name) - 1);
 	hdr.fs_blocksize = fs->blocksize;
 	
 	if (stat(device_name, &st) == 0)
diff --git a/misc/util.c b/misc/util.c
index 7522e9b..1d68d8d 100644
--- a/misc/util.c
+++ b/misc/util.c
@@ -71,8 +71,8 @@ void proceed_question(void)
 	fflush(stderr);
 	fputs(_("Proceed anyway? (y,n) "), stdout);
 	buf[0] = 0;
-	fgets(buf, sizeof(buf), stdin);
-	if (strchr(short_yes, buf[0]) == 0)
+	if (!fgets(buf, sizeof(buf), stdin) ||
+	    strchr(short_yes, buf[0]) == 0)
 		exit(1);
 }
 
