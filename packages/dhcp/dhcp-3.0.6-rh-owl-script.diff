--- dhcp/client/scripts/linux
+++ dhcp/client/scripts/linux
@@ -1,8 +1,6 @@
 #!/bin/bash
 # dhclient-script for Linux. Dan Halbert, March, 1997.
 # Updated for Linux 2.[12] by Brian J. Murrell, January 1999.
-# No guarantees about this. I'm a novice at the details of Linux
-# networking.
 
 # Notes:
 
@@ -19,13 +17,12 @@
 # address if it is not supplied. This might be much more easily done
 # by the dhclient C code, and passed on.
 
-# 4. TIMEOUT not tested. ping has a flag I don't know, and I'm suspicious
-# of the $1 in its args.
-
 make_resolv_conf() {
-  if [ "x$new_domain_name" != x ] && [ x"$new_domain_name_servers" != x ]; then
-    echo search $new_domain_name >/etc/resolv.conf
-    chmod 644 /etc/resolv.conf
+  if [ -n "$new_domain_name" ] || [ -n "$new_domain_name_servers" ]; then
+    echo '; generated by /sbin/dhclient-script' > /etc/resolv.conf
+    if [ -n "$new_domain_name" ]; then
+       echo search $new_domain_name >> /etc/resolv.conf
+    fi
     for nameserver in $new_domain_name_servers; do
       echo nameserver $nameserver >>/etc/resolv.conf
     done
@@ -106,13 +103,10 @@ fi
   
 if [ x$reason = xBOUND ] || [ x$reason = xRENEW ] || \
    [ x$reason = xREBIND ] || [ x$reason = xREBOOT ]; then
-  current_hostname=`hostname`
-  if [ x$current_hostname = x ] || \
-     [ x$current_hostname = x$old_host_name ]; then
-    if [ x$current_hostname = x ] || \
-       [ x$new_host_name != x$old_host_name ]; then
-      hostname $new_host_name
-    fi
+  if [ -n "$new_host_name" ] && need_hostname; then
+       if need_hostname || [ "`hostname`" != "$new_host_name" ]; then
+               hostname $new_host_name
+       fi
   fi
     
   if [ x$old_ip_address != x ] && [ x$alias_ip_address != x ] && \
@@ -146,7 +140,10 @@ if [ x$reason = xBOUND ] || [ x$reason = xRENEW ] || \
     ifconfig $interface:0 inet $alias_ip_address $alias_subnet_arg
     route add -host $alias_ip_address $interface:0
   fi
-  make_resolv_conf
+  if [ "${PEERDNS}" != "no" ]; then
+    make_resolv_conf
+  fi
+
   exit_with_hooks 0
 fi
 
@@ -174,8 +171,7 @@ if [ x$reason = xTIMEOUT ]; then
   ifconfig $interface inet $new_ip_address $new_subnet_arg \
 					$new_broadcast_arg
   set $new_routers
-  ############## what is -w in ping?
-  if ping -q -c 1 $1; then
+  if ping -q -c 1 -w 10 $1; then
     if [ x$new_ip_address != x$alias_ip_address ] && \
 			[ x$alias_ip_address != x ]; then
       ifconfig $interface:0 inet $alias_ip_address $alias_subnet_arg
@@ -188,7 +184,9 @@ if [ x$reason = xTIMEOUT ]; then
     for router in $new_routers; do
       route add default gw $router
     done
-    make_resolv_conf
+    if [ "${PEERDNS}" != "no" ]; then
+      make_resolv_conf
+    fi
     exit_with_hooks 0
   fi
   ifconfig $interface inet 0 down
