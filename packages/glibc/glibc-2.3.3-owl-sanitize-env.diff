diff -puNr glibc-2.3.3-200406160000.orig/elf/dl-support.c glibc-2.3.3-200406160000/elf/dl-support.c
--- glibc-2.3.3-200406160000.orig/elf/dl-support.c	Sat Jan  8 04:08:42 2005
+++ glibc-2.3.3-200406160000/elf/dl-support.c	Sat Jan  8 09:35:43 2005
@@ -211,11 +211,13 @@ _dl_aux_init (ElfW(auxv_t) *av)
 	gid ^= av->a_un.a_val;
 	seen |= 8;
 	break;
+#if 0
       case AT_SECURE:
 	seen = -1;
 	__libc_enable_secure = av->a_un.a_val;
 	__libc_enable_secure_decided = 1;
 	break;
+#endif
       }
   if (seen == 0xf)
     {
@@ -236,41 +238,68 @@ _dl_non_dynamic_init (void)
   if (!_dl_pagesize)
     _dl_pagesize = __getpagesize ();
 
-  _dl_verbose = *(getenv ("LD_WARN") ?: "") == '\0' ? 0 : 1;
+  _dl_verbose = *(__secure_getenv ("LD_WARN") ?: "") == '\0' ? 0 : 1;
 
   /* Initialize the data structures for the search paths for shared
      objects.  */
-  _dl_init_paths (getenv ("LD_LIBRARY_PATH"));
+  _dl_init_paths (__secure_getenv ("LD_LIBRARY_PATH"));
 
-  _dl_lazy = *(getenv ("LD_BIND_NOW") ?: "") == '\0';
+  _dl_lazy = *(__secure_getenv ("LD_BIND_NOW") ?: "") == '\0';
 
-  _dl_bind_not = *(getenv ("LD_BIND_NOT") ?: "") != '\0';
+  _dl_bind_not = *(__secure_getenv ("LD_BIND_NOT") ?: "") != '\0';
 
-  _dl_dynamic_weak = *(getenv ("LD_DYNAMIC_WEAK") ?: "") == '\0';
+  _dl_dynamic_weak = *(__secure_getenv ("LD_DYNAMIC_WEAK") ?: "") == '\0';
 
-  _dl_profile_output = getenv ("LD_PROFILE_OUTPUT");
+  _dl_profile_output = __secure_getenv ("LD_PROFILE_OUTPUT");
   if (_dl_profile_output == NULL || _dl_profile_output[0] == '\0')
     _dl_profile_output
       = &"/var/tmp\0/var/profile"[__libc_enable_secure ? 9 : 0];
 
   if (__libc_enable_secure)
     {
-      static const char *unsecure_envvars[] =
-      {
-	UNSECURE_ENVVARS,
+      static const char unsecure_envvars[] =
 #ifdef EXTRA_UNSECURE_ENVVARS
 	EXTRA_UNSECURE_ENVVARS
 #endif
-      };
-      size_t cnt;
+      UNSECURE_ENVVARS;
+
+      static const char restricted_envvars[] =
+#ifdef EXTRA_RESTRICTED_ENVVARS
+	EXTRA_RESTRICTED_ENVVARS
+#endif
+	RESTRICTED_ENVVARS;
 
-      for (cnt = 0;
-	   cnt < sizeof (unsecure_envvars) / sizeof (unsecure_envvars[0]);
-	   ++cnt)
-	unsetenv (unsecure_envvars[cnt]);
+      const char *nextp;
+      char *value;
 
+      nextp = unsecure_envvars;
+      do
+	{
+	  unsetenv (nextp);
+	  /* We could use rawmemchr but this need not be fast.  */
+	  nextp = (char *) (strchr) (nextp, '\0') + 1;
+	}
+      while (*nextp != '\0');
+
+      nextp = restricted_envvars;
+      do
+	{
+	  if ((value = getenv(nextp))
+	      && (*value == '.' || strchr(value, '/')))
+	    unsetenv (nextp);
+	  /* We could use rawmemchr but this need not be fast.  */
+	  nextp = (char *) (strchr) (nextp, '\0') + 1;
+	}
+      while (*nextp != '\0');
+
+#if 0
+      /*
+       * XXX: (GM): Should we leave this glibc's behaviour? Currently,
+       *            we are dropping all MALLOC_* unconditionally.
+       */
       if (__access ("/etc/suid-debug", F_OK) != 0)
 	unsetenv ("MALLOC_CHECK_");
+#endif
     }
 
 #ifdef DL_PLATFORM_INIT
diff -puNr glibc-2.3.3-200406160000.orig/elf/rtld.c glibc-2.3.3-200406160000/elf/rtld.c
--- glibc-2.3.3-200406160000.orig/elf/rtld.c	Sat Jan  8 04:08:42 2005
+++ glibc-2.3.3-200406160000/elf/rtld.c	Sat Jan  8 07:22:22 2005
@@ -2127,6 +2127,7 @@ process_envvars (enum mode *modep)
   GLRO(dl_profile_output)
     = &"/var/tmp\0/var/profile"[INTUSE(__libc_enable_secure) ? 9 : 0];
 
+  if (__builtin_expect (!INTUSE(__libc_enable_secure), 1))
   while ((envline = _dl_next_ld_env_entry (&runp)) != NULL)
     {
       size_t len = 0;
@@ -2201,8 +2202,7 @@ process_envvars (enum mode *modep)
 
 	case 11:
 	  /* Path where the binary is found.  */
-	  if (!INTUSE(__libc_enable_secure)
-	      && memcmp (envline, "ORIGIN_PATH", 11) == 0)
+	  if (memcmp (envline, "ORIGIN_PATH", 11) == 0)
 	    GLRO(dl_origin_path) = &envline[12];
 	  break;
 
@@ -2231,15 +2231,13 @@ process_envvars (enum mode *modep)
 #ifdef EXTRA_LD_ENVVARS_13
 	  EXTRA_LD_ENVVARS_13
 #endif
-	  if (!INTUSE(__libc_enable_secure)
-	      && memcmp (envline, "USE_LOAD_BIAS", 13) == 0)
+	  if (memcmp (envline, "USE_LOAD_BIAS", 13) == 0)
 	    GLRO(dl_use_load_bias) = envline[14] == '1' ? -1 : 0;
 	  break;
 
 	case 14:
 	  /* Where to place the profiling data file.  */
-	  if (!INTUSE(__libc_enable_secure)
-	      && memcmp (envline, "PROFILE_OUTPUT", 14) == 0
+	  if (memcmp (envline, "PROFILE_OUTPUT", 14) == 0
 	      && envline[15] != '\0')
 	    GLRO(dl_profile_output) = &envline[15];
 	  break;
@@ -2278,12 +2276,31 @@ process_envvars (enum mode *modep)
      variables.  */
   if (__builtin_expect (INTUSE(__libc_enable_secure), 0))
     {
+      /*
+       * These lists include both environment variables specific to the
+       * dynamic linker and generic ones used by various parts of glibc.
+       * They should be (partially?) moved to libc initialization in order
+       * to provide the same protection for statically-linked programs.
+       * Note that glibc itself tries to be careful to not trust these
+       * variables when running SUID/SGID, and it remains the responsibility
+       * of SUID/SGID programs to sanitize environment before executing
+       * other programs with matching real and effective IDs.  This is a
+       * "hardening" measure only, -- noone is supposed to rely on it.
+       */
       static const char unsecure_envvars[] =
 #ifdef EXTRA_UNSECURE_ENVVARS
 	EXTRA_UNSECURE_ENVVARS
 #endif
 	UNSECURE_ENVVARS;
+
+      static const char restricted_envvars[] =
+#ifdef EXTRA_RESTRICTED_ENVVARS
+	EXTRA_RESTRICTED_ENVVARS
+#endif
+	RESTRICTED_ENVVARS;
+
       const char *nextp;
+      char *value;
 
       nextp = unsecure_envvars;
       do
@@ -2294,8 +2311,25 @@ process_envvars (enum mode *modep)
 	}
       while (*nextp != '\0');
 
+      nextp = restricted_envvars;
+      do
+	{
+	  if ((value = getenv(nextp))
+	      && (*value == '.' || strchr(value, '/')))
+	    unsetenv (nextp);
+	  /* We could use rawmemchr but this need not be fast.  */
+	  nextp = (char *) (strchr) (nextp, '\0') + 1;
+	}
+      while (*nextp != '\0');
+
+#if 0
+      /*
+       * XXX: (GM): Should we leave this glibc's behaviour? Currently,
+       *            we are dropping all MALLOC_* unconditionally.
+       */
       if (__access ("/etc/suid-debug", F_OK) != 0)
 	unsetenv ("MALLOC_CHECK_");
+#endif
     }
   /* If we have to run the dynamic linker in debugging mode and the
      LD_DEBUG_OUTPUT environment variable is given, we write the debug
diff -puNr glibc-2.3.3-200406160000.orig/gmon/gmon.c glibc-2.3.3-200406160000/gmon/gmon.c
--- glibc-2.3.3-200406160000.orig/gmon/gmon.c	Thu Apr 22 08:55:00 2004
+++ glibc-2.3.3-200406160000/gmon/gmon.c	Sat Jan  8 07:25:53 2005
@@ -326,8 +326,8 @@ write_gmon (void)
 # define O_NOFOLLOW	0
 #endif
 
-    env = getenv ("GMON_OUT_PREFIX");
-    if (env != NULL && !__libc_enable_secure)
+    env = __secure_getenv ("GMON_OUT_PREFIX");
+    if (env != NULL)
       {
 	size_t len = strlen (env);
 	char buf[len + 20];
diff -puNr glibc-2.3.3-200406160000.orig/iconv/gconv_cache.c glibc-2.3.3-200406160000/iconv/gconv_cache.c
--- glibc-2.3.3-200406160000.orig/iconv/gconv_cache.c	Mon Jun 30 08:29:03 2003
+++ glibc-2.3.3-200406160000/iconv/gconv_cache.c	Sat Jan  8 07:27:31 2005
@@ -55,7 +55,7 @@ __gconv_load_cache (void)
 
   /* We cannot use the cache if the GCONV_PATH environment variable is
      set.  */
-  __gconv_path_envvar = getenv ("GCONV_PATH");
+  __gconv_path_envvar = __locale_getenv ("GCONV_PATH");
   if (__gconv_path_envvar != NULL)
     return -1;
 
diff -puNr glibc-2.3.3-200406160000.orig/include/stdlib.h glibc-2.3.3-200406160000/include/stdlib.h
--- glibc-2.3.3-200406160000.orig/include/stdlib.h	Wed Aug 28 11:09:38 2002
+++ glibc-2.3.3-200406160000/include/stdlib.h	Sat Jan  8 07:28:46 2005
@@ -29,6 +29,7 @@ libc_hidden_proto (qecvt_r)
 libc_hidden_proto (qfcvt_r)
 libc_hidden_proto (lrand48_r)
 libc_hidden_proto (wctomb)
+libc_hidden_proto (__locale_getenv)
 libc_hidden_proto (__secure_getenv)
 libc_hidden_proto (__strtof_internal)
 libc_hidden_proto (__strtod_internal)
diff -puNr glibc-2.3.3-200406160000.orig/intl/dcigettext.c glibc-2.3.3-200406160000/intl/dcigettext.c
--- glibc-2.3.3-200406160000.orig/intl/dcigettext.c	Mon Jun 30 08:29:07 2003
+++ glibc-2.3.3-200406160000/intl/dcigettext.c	Sat Jan  8 07:29:38 2005
@@ -1091,7 +1091,7 @@ guess_category_value (category, category
   /* The highest priority value is the `LANGUAGE' environment
      variable.  But we don't use the value if the currently selected
      locale is the C locale.  This is a GNU extension.  */
-  language = getenv ("LANGUAGE");
+  language = __locale_getenv ("LANGUAGE");
   if (language != NULL && language[0] == '\0')
     language = NULL;
 
diff -puNr glibc-2.3.3-200406160000.orig/intl/loadmsgcat.c glibc-2.3.3-200406160000/intl/loadmsgcat.c
--- glibc-2.3.3-200406160000.orig/intl/loadmsgcat.c	Wed Apr 14 17:39:19 2004
+++ glibc-2.3.3-200406160000/intl/loadmsgcat.c	Sat Jan  8 07:30:25 2005
@@ -815,7 +815,7 @@ _nl_init_domain_conv (domain_file, domai
 	    outcharset = domainbinding->codeset;
 	  else
 	    {
-	      outcharset = getenv ("OUTPUT_CHARSET");
+	      outcharset = __locale_getenv ("OUTPUT_CHARSET");
 	      if (outcharset == NULL || outcharset[0] == '\0')
 		{
 # ifdef _LIBC
diff -puNr glibc-2.3.3-200406160000.orig/io/getdirname.c glibc-2.3.3-200406160000/io/getdirname.c
--- glibc-2.3.3-200406160000.orig/io/getdirname.c	Fri Jul  6 04:54:53 2001
+++ glibc-2.3.3-200406160000/io/getdirname.c	Sat Jan  8 05:51:37 2005
@@ -31,7 +31,9 @@ get_current_dir_name (void)
   char *pwd;
   struct stat64 dotstat, pwdstat;
 
-  pwd = getenv ("PWD");
+  /* A plain getenv() could let one check for subdirectories of a directory
+     only accessible to the effective privileges of the program.  */
+  pwd = __secure_getenv ("PWD");
   if (pwd != NULL
       && stat64 (".", &dotstat) == 0
       && stat64 (pwd, &pwdstat) == 0
diff -puNr glibc-2.3.3-200406160000.orig/libidn/toutf8.c glibc-2.3.3-200406160000/libidn/toutf8.c
--- glibc-2.3.3-200406160000.orig/libidn/toutf8.c	Mon Mar  8 20:52:56 2004
+++ glibc-2.3.3-200406160000/libidn/toutf8.c	Sat Jan  8 07:33:47 2005
@@ -71,7 +71,7 @@
 const char *
 stringprep_locale_charset (void)
 {
-  const char *charset = getenv ("CHARSET");	/* flawfinder: ignore */
+  const char *charset = __secure_getenv ("CHARSET");	/* flawfinder: ignore */
 
   if (charset && *charset)
     return charset;
diff -puNr glibc-2.3.3-200406160000.orig/locale/findlocale.c glibc-2.3.3-200406160000/locale/findlocale.c
--- glibc-2.3.3-200406160000.orig/locale/findlocale.c	Mon Jun 30 08:29:11 2003
+++ glibc-2.3.3-200406160000/locale/findlocale.c	Sat Jan  8 07:35:36 2005
@@ -78,16 +78,14 @@ _nl_find_locale (const char *locale_path
     {
       /* The user decides which locale to use by setting environment
 	 variables.  */
-      *name = getenv ("LC_ALL");
+      *name = __locale_getenv ("LC_ALL");
       if (*name == NULL || (*name)[0] == '\0')
-	*name = getenv (_nl_category_names[category]);
+	*name = __locale_getenv (_nl_category_names[category]);
       if (*name == NULL || (*name)[0] == '\0')
-	*name = getenv ("LANG");
+	*name = __locale_getenv ("LANG");
     }
 
-  if (*name == NULL || (*name)[0] == '\0'
-      || (__builtin_expect (__libc_enable_secure, 0)
-	  && strchr (*name, '/') != NULL))
+  if (*name == NULL || (*name)[0] == '\0')
     *name = (char *) _nl_C_name;
 
   if (__builtin_expect (strcmp (*name, _nl_C_name), 1) == 0
diff -puNr glibc-2.3.3-200406160000.orig/locale/newlocale.c glibc-2.3.3-200406160000/locale/newlocale.c
--- glibc-2.3.3-200406160000.orig/locale/newlocale.c	Thu Oct 17 12:13:50 2002
+++ glibc-2.3.3-200406160000/locale/newlocale.c	Sat Jan  8 07:55:16 2005
@@ -98,7 +98,7 @@ __newlocale (int category_mask, const ch
   locale_path = NULL;
   locale_path_len = 0;
 
-  locpath_var = getenv ("LOCPATH");
+  locpath_var = __secure_getenv ("LOCPATH");
   if (locpath_var != NULL && locpath_var[0] != '\0')
     {
       if (__argz_create_sep (locpath_var, ':',
diff -puNr glibc-2.3.3-200406160000.orig/locale/setlocale.c glibc-2.3.3-200406160000/locale/setlocale.c
--- glibc-2.3.3-200406160000.orig/locale/setlocale.c	Wed Jan 14 21:47:24 2004
+++ glibc-2.3.3-200406160000/locale/setlocale.c	Sat Jan  8 07:55:55 2005
@@ -236,7 +236,7 @@ setlocale (int category, const char *loc
   locale_path = NULL;
   locale_path_len = 0;
 
-  locpath_var = getenv ("LOCPATH");
+  locpath_var = __secure_getenv ("LOCPATH");
   if (locpath_var != NULL && locpath_var[0] != '\0')
     {
       if (__argz_create_sep (locpath_var, ':',
diff -puNr glibc-2.3.3-200406160000.orig/malloc/arena.c glibc-2.3.3-200406160000/malloc/arena.c
--- glibc-2.3.3-200406160000.orig/malloc/arena.c	Mon Aug  4 19:16:08 2003
+++ glibc-2.3.3-200406160000/malloc/arena.c	Sat Jan  8 08:05:00 2005
@@ -433,10 +433,10 @@ ptmalloc_init __MALLOC_P((void))
 #  undef NO_STARTER
 # endif
 #endif
+  s = NULL;
 #ifdef _LIBC
   secure = __libc_enable_secure;
-  s = NULL;
-  if (__builtin_expect (_environ != NULL, 1))
+  if (! secure && __builtin_expect (_environ != NULL, 1))
     {
       char **runp = _environ;
       char *envline;
@@ -459,21 +459,18 @@ ptmalloc_init __MALLOC_P((void))
 		s = &envline[7];
 	      break;
 	    case 8:
-	      if (! secure && memcmp (envline, "TOP_PAD_", 8) == 0)
+	      if (memcmp (envline, "TOP_PAD_", 8) == 0)
 		mALLOPt(M_TOP_PAD, atoi(&envline[9]));
 	      break;
 	    case 9:
-	      if (! secure && memcmp (envline, "MMAP_MAX_", 9) == 0)
+	      if (memcmp (envline, "MMAP_MAX_", 9) == 0)
 		mALLOPt(M_MMAP_MAX, atoi(&envline[10]));
 	      break;
 	    case 15:
-	      if (! secure)
-		{
-		  if (memcmp (envline, "TRIM_THRESHOLD_", 15) == 0)
-		    mALLOPt(M_TRIM_THRESHOLD, atoi(&envline[16]));
-		  else if (memcmp (envline, "MMAP_THRESHOLD_", 15) == 0)
-		    mALLOPt(M_MMAP_THRESHOLD, atoi(&envline[16]));
-		}
+	      if (memcmp (envline, "TRIM_THRESHOLD_", 15) == 0)
+	        mALLOPt(M_TRIM_THRESHOLD, atoi(&envline[16]));
+	      else if (memcmp (envline, "MMAP_THRESHOLD_", 15) == 0)
+	        mALLOPt(M_MMAP_THRESHOLD, atoi(&envline[16]));
 	      break;
 	    default:
 	      break;
diff -puNr glibc-2.3.3-200406160000.orig/malloc/memusage.c glibc-2.3.3-200406160000/malloc/memusage.c
--- glibc-2.3.3-200406160000.orig/malloc/memusage.c	Tue Jun 18 21:53:41 2002
+++ glibc-2.3.3-200406160000/malloc/memusage.c	Sat Jan  8 08:08:04 2005
@@ -193,7 +193,7 @@ int_handler (int signo)
 static void
 me (void)
 {
-  const char *env = getenv ("MEMUSAGE_PROG_NAME");
+  const char *env = __secure_getenv ("MEMUSAGE_PROG_NAME");
   size_t prog_len = strlen (__progname);
 
   initialized = -1;
@@ -229,7 +229,7 @@ me (void)
       if (!start_sp)
 	start_sp = GETSP ();
 
-      outname = getenv ("MEMUSAGE_OUTPUT");
+      outname = __secure_getenv ("MEMUSAGE_OUTPUT");
       if (outname != NULL && outname[0] != '\0'
 	  && (access (outname, R_OK | W_OK) == 0 || errno == ENOENT))
 	{
@@ -251,7 +251,7 @@ me (void)
 	      /* Determine the buffer size.  We use the default if the
 		 environment variable is not present.  */
 	      buffer_size = DEFAULT_BUFFER_SIZE;
-	      if (getenv ("MEMUSAGE_BUFFER_SIZE") != NULL)
+	      if (__secure_getenv ("MEMUSAGE_BUFFER_SIZE") != NULL)
 		{
 		  buffer_size = atoi (getenv ("MEMUSAGE_BUFFER_SIZE"));
 		  if (buffer_size == 0 || buffer_size > DEFAULT_BUFFER_SIZE)
@@ -259,7 +259,7 @@ me (void)
 		}
 
 	      /* Possibly enable timer-based stack pointer retrieval.  */
-	      if (getenv ("MEMUSAGE_NO_TIMER") == NULL)
+	      if (__secure_getenv ("MEMUSAGE_NO_TIMER") == NULL)
 		{
 		  struct sigaction act;
 
@@ -280,7 +280,7 @@ me (void)
 	    }
 	}
 
-      if (!not_me && getenv ("MEMUSAGE_TRACE_MMAP") != NULL)
+      if (!not_me && __secure_getenv ("MEMUSAGE_TRACE_MMAP") != NULL)
 	trace_mmap = true;
     }
 }
diff -puNr glibc-2.3.3-200406160000.orig/nis/nis_defaults.c glibc-2.3.3-200406160000/nis/nis_defaults.c
--- glibc-2.3.3-200406160000.orig/nis/nis_defaults.c	Fri Jul  6 04:55:36 2001
+++ glibc-2.3.3-200406160000/nis/nis_defaults.c	Sat Jan  8 08:12:47 2005
@@ -379,7 +379,7 @@ __nis_default_owner (char *defaults)
     }
   else
     {
-      cptr = getenv ("NIS_DEFAULTS");
+      cptr = __secure_getenv ("NIS_DEFAULTS");
       if (cptr != NULL)
 	{
 	  dptr = strstr (cptr, "owner=");
@@ -418,7 +418,7 @@ __nis_default_group (char *defaults)
     }
   else
     {
-      cptr = getenv ("NIS_DEFAULTS");
+      cptr = __secure_getenv ("NIS_DEFAULTS");
       if (cptr != NULL)
 	{
 	  dptr = strstr (cptr, "group=");
@@ -448,7 +448,7 @@ __nis_default_ttl (char *defaults)
 	return searchttl (defaults);
     }
 
-  cptr = getenv ("NIS_DEFAULTS");
+  cptr = __secure_getenv ("NIS_DEFAULTS");
   if (cptr == NULL)
     return DEFAULT_TTL;
 
@@ -476,7 +476,7 @@ __nis_default_access (char *param, unsig
     result = searchaccess (param, result);
   else
     {
-      cptr = getenv ("NIS_DEFAULTS");
+      cptr = __secure_getenv ("NIS_DEFAULTS");
       if (cptr != NULL && strstr (cptr, "access=") != NULL)
 	result = searchaccess (getenv ("NIS_DEFAULTS"), result);
     }
diff -puNr glibc-2.3.3-200406160000.orig/nis/nis_local_names.c glibc-2.3.3-200406160000/nis/nis_local_names.c
--- glibc-2.3.3-200406160000.orig/nis/nis_local_names.c	Fri Jul  6 04:55:36 2001
+++ glibc-2.3.3-200406160000/nis/nis_local_names.c	Sat Jan  8 08:13:33 2005
@@ -33,7 +33,7 @@ nis_local_group (void)
       char *cptr;
       char *cp;
 
-      if ((cptr = getenv ("NIS_GROUP")) == NULL)
+      if ((cptr = __secure_getenv ("NIS_GROUP")) == NULL)
 	return __nisgroup;
 
       if (strlen (cptr) >= NIS_MAXNAMELEN)
diff -puNr glibc-2.3.3-200406160000.orig/nis/nis_subr.c glibc-2.3.3-200406160000/nis/nis_subr.c
--- glibc-2.3.3-200406160000.orig/nis/nis_subr.c	Fri May  7 12:20:26 2004
+++ glibc-2.3.3-200406160000/nis/nis_subr.c	Sat Jan  8 08:14:51 2005
@@ -150,7 +150,7 @@ nis_getnames (const_nis_name name)
     }
 
   /* Get the search path, where we have to search "name" */
-  path = getenv ("NIS_PATH");
+  path = __secure_getenv ("NIS_PATH");
   if (path == NULL)
     path = strdupa ("$");
   else
diff -puNr glibc-2.3.3-200406160000.orig/posix/execvp.c glibc-2.3.3-200406160000/posix/execvp.c
--- glibc-2.3.3-200406160000.orig/posix/execvp.c	Mon Aug  5 09:48:27 2002
+++ glibc-2.3.3-200406160000/posix/execvp.c	Sat Jan  8 08:18:25 2005
@@ -81,16 +81,15 @@ execvp (file, argv)
       size_t len;
       size_t pathlen;
 
-      path = getenv ("PATH");
+      path = __secure_getenv ("PATH");
       if (path == NULL)
 	{
 	  /* There is no `PATH' in the environment.
-	     The default search path is the current directory
-	     followed by the path `confstr' returns for `_CS_PATH'.  */
+	     The default search path is what `confstr' returns
+	     for `_CS_PATH'.  */
 	  len = confstr (_CS_PATH, (char *) NULL, 0);
-	  path = (char *) __alloca (1 + len);
-	  path[0] = ':';
-	  (void) confstr (_CS_PATH, path + 1, len);
+	  path = (char *) __alloca (len);
+	  (void) confstr (_CS_PATH, path, len);
 	}
 
       len = strlen (file) + 1;
diff -puNr glibc-2.3.3-200406160000.orig/resolv/res_hconf.c glibc-2.3.3-200406160000/resolv/res_hconf.c
--- glibc-2.3.3-200406160000.orig/resolv/res_hconf.c	Wed Jun  2 01:42:55 2004
+++ glibc-2.3.3-200406160000/resolv/res_hconf.c	Sat Jan  8 08:20:15 2005
@@ -431,7 +431,7 @@ do_init (void)
 
   memset (&_res_hconf, '\0', sizeof (_res_hconf));
 
-  hconf_name = getenv (ENV_HOSTCONF);
+  hconf_name = __secure_getenv (ENV_HOSTCONF);
   if (hconf_name == NULL)
     hconf_name = _PATH_HOSTCONF;
 
@@ -453,30 +453,30 @@ do_init (void)
       fclose (fp);
     }
 
-  envval = getenv (ENV_SERVORDER);
+  envval = __secure_getenv (ENV_SERVORDER);
   if (envval)
     {
       _res_hconf.num_services = 0;
       arg_service_list (ENV_SERVORDER, 1, envval, 0);
     }
 
-  envval = getenv (ENV_SPOOF);
+  envval = __secure_getenv (ENV_SPOOF);
   if (envval)
     arg_spoof (ENV_SPOOF, 1, envval, 0);
 
-  envval = getenv (ENV_MULTI);
+  envval = __secure_getenv (ENV_MULTI);
   if (envval)
     arg_bool (ENV_MULTI, 1, envval, HCONF_FLAG_MULTI);
 
-  envval = getenv (ENV_REORDER);
+  envval = __secure_getenv (ENV_REORDER);
   if (envval)
     arg_bool (ENV_REORDER, 1, envval, HCONF_FLAG_REORDER);
 
-  envval = getenv (ENV_TRIM_ADD);
+  envval = __secure_getenv (ENV_TRIM_ADD);
   if (envval)
     arg_trimdomain_list (ENV_TRIM_ADD, 1, envval, 0);
 
-  envval = getenv (ENV_TRIM_OVERR);
+  envval = __secure_getenv (ENV_TRIM_OVERR);
   if (envval)
     {
       _res_hconf.num_trimdomains = 0;
diff -puNr glibc-2.3.3-200406160000.orig/resolv/res_init.c glibc-2.3.3-200406160000/resolv/res_init.c
--- glibc-2.3.3-200406160000.orig/resolv/res_init.c	Sat Jan  8 04:08:42 2005
+++ glibc-2.3.3-200406160000/resolv/res_init.c	Sat Jan  8 08:20:55 2005
@@ -194,7 +194,7 @@ __res_vinit(res_state statp, int preinit
 #endif
 
 	/* Allow user to override the local domain definition */
-	if ((cp = getenv("LOCALDOMAIN")) != NULL) {
+	if ((cp = __secure_getenv("LOCALDOMAIN")) != NULL) {
 		(void)strncpy(statp->defdname, cp, sizeof(statp->defdname) - 1);
 		statp->defdname[sizeof(statp->defdname) - 1] = '\0';
 		haveenv++;
@@ -434,7 +434,7 @@ __res_vinit(res_state statp, int preinit
 #endif /* !RFC1535 */
 	}
 
-	if ((cp = getenv("RES_OPTIONS")) != NULL)
+	if ((cp = __secure_getenv("RES_OPTIONS")) != NULL)
 		res_setoptions(statp, cp, "env");
 	statp->options |= RES_INIT;
 	return (0);
diff -puNr glibc-2.3.3-200406160000.orig/resolv/res_query.c glibc-2.3.3-200406160000/resolv/res_query.c
--- glibc-2.3.3-200406160000.orig/resolv/res_query.c	Sat Nov  2 22:58:17 2002
+++ glibc-2.3.3-200406160000/resolv/res_query.c	Sat Jan  8 08:21:33 2005
@@ -442,7 +442,7 @@ res_hostalias(const res_state statp, con
 
 	if (statp->options & RES_NOALIASES)
 		return (NULL);
-	file = getenv("HOSTALIASES");
+	file = __secure_getenv("HOSTALIASES");
 	if (file == NULL || (fp = fopen(file, "r")) == NULL)
 		return (NULL);
 	setbuf(fp, NULL);
diff -puNr glibc-2.3.3-200406160000.orig/stdlib/Versions glibc-2.3.3-200406160000/stdlib/Versions
--- glibc-2.3.3-200406160000.orig/stdlib/Versions	Fri May  7 12:20:30 2004
+++ glibc-2.3.3-200406160000/stdlib/Versions	Sat Jan  8 08:24:54 2005
@@ -90,6 +90,9 @@ libc {
     # used by new G++ ABI
     __cxa_atexit; __cxa_finalize;
   }
+  GLIBC_2.2.4 {
+    __locale_getenv;
+  }
   GLIBC_2.3 {
     # Silent change in SUS.
     realpath;
diff -puNr glibc-2.3.3-200406160000.orig/stdlib/fmtmsg.c glibc-2.3.3-200406160000/stdlib/fmtmsg.c
--- glibc-2.3.3-200406160000.orig/stdlib/fmtmsg.c	Sat Sep 27 21:59:34 2003
+++ glibc-2.3.3-200406160000/stdlib/fmtmsg.c	Sat Jan  8 08:25:30 2005
@@ -226,8 +226,8 @@ fmtmsg (long int classification, const c
 static void
 init (void)
 {
-  const char *msgverb_var = getenv ("MSGVERB");
-  const char *sevlevel_var = getenv ("SEV_LEVEL");
+  const char *msgverb_var = __secure_getenv ("MSGVERB");
+  const char *sevlevel_var = __secure_getenv ("SEV_LEVEL");
 
   if (msgverb_var != NULL && msgverb_var[0] != '\0')
     {
diff -puNr glibc-2.3.3-200406160000.orig/stdlib/secure-getenv.c glibc-2.3.3-200406160000/stdlib/secure-getenv.c
--- glibc-2.3.3-200406160000.orig/stdlib/secure-getenv.c	Mon Aug  5 09:48:28 2002
+++ glibc-2.3.3-200406160000/stdlib/secure-getenv.c	Sat Jan  8 08:33:12 2005
@@ -18,6 +18,7 @@
 
 #include <stdlib.h>
 #include <unistd.h>
+#include <string.h>
 
 /* Some programs and especially the libc itself have to be careful
    what values to accept from the environment.  This special version
@@ -29,3 +30,15 @@ __secure_getenv (name)
   return __libc_enable_secure ? NULL : getenv (name);
 }
 libc_hidden_def (__secure_getenv)
+
+char *
+__locale_getenv (name)
+     const char *name;
+{
+  char *value = getenv (name);
+  if ( value &&
+      __libc_enable_secure && (('.' == value[0]) || strchr(value, '/')) )
+    return NULL;
+  return value;
+}
+libc_hidden_def (__locale_getenv)
diff -puNr glibc-2.3.3-200406160000.orig/stdlib/stdlib.h glibc-2.3.3-200406160000/stdlib/stdlib.h
--- glibc-2.3.3-200406160000.orig/stdlib/stdlib.h	Sat Jan  8 05:33:56 2005
+++ glibc-2.3.3-200406160000/stdlib/stdlib.h	Sat Jan  8 08:37:05 2005
@@ -630,6 +630,11 @@ __END_NAMESPACE_STD
    programs is running with SUID or SGID enabled.  */
 extern char *__secure_getenv (__const char *__name) __THROW;
 
+/* This function is similar to the above but returns NULL if the
+   programs is running with SUID or SGID enabled and value starts
+   with "." symbol or contains "/" symbols.  */
+extern char *__locale_getenv (__const char *__name) __THROW;
+
 #if defined __USE_SVID || defined __USE_XOPEN
 /* The SVID says this is in <stdio.h>, but this seems a better place.	*/
 /* Put STRING, which is of the form "NAME=VALUE", in the environment.
diff -puNr glibc-2.3.3-200406160000.orig/sunrpc/rpc_svcout.c glibc-2.3.3-200406160000/sunrpc/rpc_svcout.c
--- glibc-2.3.3-200406160000.orig/sunrpc/rpc_svcout.c	Tue Jun 18 21:54:29 2002
+++ glibc-2.3.3-200406160000/sunrpc/rpc_svcout.c	Sat Jan  8 08:38:59 2005
@@ -899,7 +899,7 @@ write_pm_most (const char *infile, int n
   f_print (fout, "\t\t_rpcpmstart = 1;\n");
   if (logflag)
     open_log_file (infile, "\t\t");
-  f_print (fout, "\t\tif ((netid = getenv(\"NLSPROVIDER\")) == NULL) {\n");
+  f_print (fout, "\t\tif ((netid = __secure_getenv(\"NLSPROVIDER\")) == NULL) {\n");
   sprintf (_errbuf, "cannot get transport name");
   print_err_message ("\t\t\t");
   f_print (fout, "\t\t} else if ((nconf = getnetconfigent(netid)) == NULL) {\n");
diff -puNr glibc-2.3.3-200406160000.orig/sysdeps/generic/glob.c glibc-2.3.3-200406160000/sysdeps/generic/glob.c
--- glibc-2.3.3-200406160000.orig/sysdeps/generic/glob.c	Wed Apr 14 17:39:58 2004
+++ glibc-2.3.3-200406160000/sysdeps/generic/glob.c	Sat Jan  8 05:51:37 2005
@@ -171,7 +171,7 @@ extern int errno;
 # define	ANSI_STRING
 #else	/* No standard headers.  */
 
-extern char *getenv ();
+extern char *__secure_getenv ();
 
 # ifdef HAVE_STRING_H
 #  include <string.h>
@@ -694,7 +694,7 @@ glob (pattern, flags, errfunc, pglob)
       if (dirname[1] == '\0' || dirname[1] == '/')
 	{
 	  /* Look up home directory.  */
-	  const char *home_dir = getenv ("HOME");
+	  const char *home_dir = __secure_getenv ("HOME");
 # ifdef _AMIGA
 	  if (home_dir == NULL || home_dir[0] == '\0')
 	    home_dir = "SYS:";
diff -puNr glibc-2.3.3-200406160000.orig/sysdeps/generic/segfault.c glibc-2.3.3-200406160000/sysdeps/generic/segfault.c
--- glibc-2.3.3-200406160000.orig/sysdeps/generic/segfault.c	Tue Feb 10 08:32:01 2004
+++ glibc-2.3.3-200406160000/sysdeps/generic/segfault.c	Sat Jan  8 08:43:51 2005
@@ -197,7 +197,7 @@ __attribute__ ((constructor))
 install_handler (void)
 {
   struct sigaction sa;
-  const char *sigs = getenv ("SEGFAULT_SIGNALS");
+  const char *sigs = __secure_getenv ("SEGFAULT_SIGNALS");
   const char *name;
 
   sa.sa_handler = (void *) catch_segfault;
@@ -205,7 +205,7 @@ install_handler (void)
   sa.sa_flags = SA_RESTART;
 
   /* Maybe we are expected to use an alternative stack.  */
-  if (getenv ("SEGFAULT_USE_ALTSTACK") != 0)
+  if (__secure_getenv ("SEGFAULT_USE_ALTSTACK") != 0)
     {
       void *stack_mem = malloc (2 * SIGSTKSZ);
       struct sigaltstack ss;
@@ -251,7 +251,7 @@ install_handler (void)
     }
 
   /* Preserve the output file name if there is any given.  */
-  name = getenv ("SEGFAULT_OUTPUT_NAME");
+  name = __secure_getenv ("SEGFAULT_OUTPUT_NAME");
   if (name != NULL && name[0] != '\0')
     {
       int ret = access (name, R_OK | W_OK);
diff -puNr glibc-2.3.3-200406160000.orig/sysdeps/generic/unsecvars.h glibc-2.3.3-200406160000/sysdeps/generic/unsecvars.h
--- glibc-2.3.3-200406160000.orig/sysdeps/generic/unsecvars.h	Fri Dec 19 11:59:02 2003
+++ glibc-2.3.3-200406160000/sysdeps/generic/unsecvars.h	Sat Jan  8 09:10:31 2005
@@ -2,19 +2,79 @@
    all stuffed in a single string which means they have to be terminated
    with a '\0' explicitly.  */
 #define UNSECURE_ENVVARS \
-  "LD_PRELOAD\0"							      \
+  "ARGP_HELP_FMT\0"							      \
+  "DATEMSK\0"								      \
+  "GCONV_PATH\0"							      \
+  "GMON_OUT_PREFIX\0"							      \
+  "HES_DOMAIN\0"							      \
+  "HESIOD_CONFIG\0"							      \
+  "HOSTALIASES\0"							      \
+  "LD_BIND_NOT\0"							      \
+  "LD_BIND_NOW\0"							      \
+  "LD_DEBUG\0"								      \
+  "LD_DEBUG_OUTPUT\0"							      \
+  "LD_DYNAMIC_WEAK\0"							      \
+  "LD_HWCAP_MASK\0"							      \
   "LD_LIBRARY_PATH\0"							      \
   "LD_ORIGIN_PATH\0"							      \
-  "LD_DEBUG_OUTPUT\0"							      \
+  "LD_PRELOAD\0"							      \
   "LD_PROFILE\0"							      \
+  "LD_PROFILE_OUTPUT\0"							      \
+  "LD_SHOW_AUXV\0"							      \
+  "LD_TRACE_LOADED_OBJECTS\0"						      \
   "LD_USE_LOAD_BIAS\0"							      \
-  "GCONV_PATH\0"							      \
-  "HOSTALIASES\0"							      \
+  "LD_WARN\0"								      \
   "LOCALDOMAIN\0"							      \
   "LOCPATH\0"								      \
+  "MALLOC_CHECK_\0"							      \
+  "MALLOC_MMAP_MAX_\0"							      \
+  "MALLOC_MMAP_THRESHOLD_\0"						      \
+  "MALLOC_TOP_PAD_\0"							      \
   "MALLOC_TRACE\0"							      \
+  "MALLOC_TRIM_TRESHOLD_\0"						      \
+  "MEMUSAGE_BUFFER_SIZE\0"						      \
+  "MEMUSAGE_NO_TIMER\0"							      \
+  "MEMUSAGE_OUTPUT\0"							      \
+  "MEMUSAGE_PROG_NAME\0"						      \
+  "MEMUSAGE_TRACE_MMAP\0"						      \
+  "MSGVERB\0"								      \
+  "NIS_DEFAULTS\0"							      \
+  "NIS_GROUP\0"								      \
+  "NIS_PATH\0"								      \
   "NLSPATH\0"								      \
+  "PCPROFILE_OUTPUT\0"							      \
+  "PWD\0"								      \
+  "RESOLV_ADD_TRIM_DOMAINS\0"						      \
   "RESOLV_HOST_CONF\0"							      \
+  "RESOLV_MULTI\0"							      \
+  "RESOLV_OVERRIDE_TRIM_DOMAINS\0"					      \
+  "RESOLV_REORDER\0"							      \
+  "RESOLV_SERV_REORDER\0"						      \
+  "RESOLV_SPOOF_CHECK\0"						      \
   "RES_OPTIONS\0"							      \
+  "SEGFAULT_OUTPUT_NAME\0"						      \
+  "SEGFAULT_SIGNALS\0"							      \
+  "SEGFAULT_USE_ALTSTACK\0"						      \
+  "SEV_LEVEL\0"								      \
   "TMPDIR\0"								      \
+  "TZ\0"								      \
   "TZDIR\0"
+
+#define RESTRICTED_ENVVARS \
+  "LANG\0"								      \
+  "LANGUAGE\0"								      \
+  "LINGUAS\0"								      \
+  "LC_CTYPE\0"								      \
+  "LC_NUMERIC\0"							      \
+  "LC_TIME\0"								      \
+  "LC_COLLATE\0"							      \
+  "LC_MONETARY\0"							      \
+  "LC_MESSAGES\0"							      \
+  "LC_PAPER\0"								      \
+  "LC_NAME\0"								      \
+  "LC_ADDRESS\0"							      \
+  "LC_TELEPHONE\0"							      \
+  "LC_MEASUREMENT\0"							      \
+  "LC_IDENTIFICATION\0"							      \
+  "LC_ALL\0"								      \
+  "LC_XXX\0"
diff -puNr glibc-2.3.3-200406160000.orig/sysdeps/generic/wordexp.c glibc-2.3.3-200406160000/sysdeps/generic/wordexp.c
--- glibc-2.3.3-200406160000.orig/sysdeps/generic/wordexp.c	Sat Sep 27 21:59:35 2003
+++ glibc-2.3.3-200406160000/sysdeps/generic/wordexp.c	Sat Jan  8 09:12:43 2005
@@ -315,7 +315,7 @@ parse_tilde (char **word, size_t *word_l
 	 results are unspecified.  We do a lookup on the uid if
 	 HOME is unset. */
 
-      home = getenv ("HOME");
+      home = __secure_getenv ("HOME");
       if (home != NULL)
 	{
 	  *word = w_addstr (*word, word_length, max_length, home);
@@ -1489,7 +1489,7 @@ envsubst:
 	}
     }
   else
-    value = getenv (env);
+    value = __secure_getenv (env);
 
   if (value == NULL && (flags & WRDE_UNDEF))
     {
@@ -2266,7 +2266,7 @@ wordexp (const char *words, wordexp_t *p
   /* Find out what the field separators are.
    * There are two types: whitespace and non-whitespace.
    */
-  ifs = getenv ("IFS");
+  ifs = __secure_getenv ("IFS");
 
   if (!ifs)
     /* IFS unset - use <space><tab><newline>. */
diff -puNr glibc-2.3.3-200406160000.orig/sysdeps/posix/spawni.c glibc-2.3.3-200406160000/sysdeps/posix/spawni.c
--- glibc-2.3.3-200406160000.orig/sysdeps/posix/spawni.c	Mon Aug  4 19:16:17 2003
+++ glibc-2.3.3-200406160000/sysdeps/posix/spawni.c	Sat Jan  8 09:14:36 2005
@@ -213,16 +213,15 @@ __spawni (pid_t *pid, const char *file,
     }
 
   /* We have to search for FILE on the path.  */
-  path = getenv ("PATH");
+  path = __secure_getenv ("PATH");
   if (path == NULL)
     {
       /* There is no `PATH' in the environment.
-	 The default search path is the current directory
-	 followed by the path `confstr' returns for `_CS_PATH'.  */
+	 The default search path is what `confstr' returns
+	 for `_CS_PATH'.  */
       len = confstr (_CS_PATH, (char *) NULL, 0);
-      path = (char *) __alloca (1 + len);
-      path[0] = ':';
-      (void) confstr (_CS_PATH, path + 1, len);
+      path = (char *) __alloca (len);
+      (void) confstr (_CS_PATH, path, len);
     }
 
   len = strlen (file) + 1;
diff -puNr glibc-2.3.3-200406160000.orig/sysdeps/unix/sysv/linux/dl-librecon.h glibc-2.3.3-200406160000/sysdeps/unix/sysv/linux/dl-librecon.h
--- glibc-2.3.3-200406160000.orig/sysdeps/unix/sysv/linux/dl-librecon.h	Wed Apr 14 17:40:24 2004
+++ glibc-2.3.3-200406160000/sysdeps/unix/sysv/linux/dl-librecon.h	Sat Jan  8 09:27:34 2005
@@ -45,7 +45,8 @@ _dl_osversion_init (char *assume_kernel)
 
 /* Recognizing extra environment variables.  */
 #define EXTRA_LD_ENVVARS_13 \
-    if (memcmp (envline, "ASSUME_KERNEL", 13) == 0)			      \
+    if (!INTUSE(__libc_enable_secure)					      \
+       && memcmp (envline, "ASSUME_KERNEL", 13) == 0)			      \
       {									      \
 	_dl_osversion_init (&envline[14]);				      \
 	break;								      \
@@ -53,7 +54,7 @@ _dl_osversion_init (char *assume_kernel)
 
 #define DL_OSVERSION_INIT \
   do {									      \
-    char *assume_kernel = getenv ("LD_ASSUME_KERNEL");			      \
+    char *assume_kernel = __secure_getenv ("LD_ASSUME_KERNEL");		      \
     if (assume_kernel)							      \
       _dl_osversion_init (assume_kernel);				      \
   } while (0)
diff -puNr glibc-2.3.3-200406160000.orig/sysdeps/unix/sysv/linux/i386/dl-librecon.h glibc-2.3.3-200406160000/sysdeps/unix/sysv/linux/i386/dl-librecon.h
--- glibc-2.3.3-200406160000.orig/sysdeps/unix/sysv/linux/i386/dl-librecon.h	Wed Apr 14 17:40:27 2004
+++ glibc-2.3.3-200406160000/sysdeps/unix/sysv/linux/i386/dl-librecon.h	Sat Jan  8 09:25:14 2005
@@ -50,13 +50,15 @@
 /* Recognizing extra environment variables.  */
 #define EXTRA_LD_ENVVARS \
   case 15:								      \
-    if (memcmp (envline, "LIBRARY_VERSION", 15) == 0)			      \
+    if (!INTUSE(__libc_enable_secure)					      \
+       && memcmp (envline, "LIBRARY_VERSION", 15) == 0)			      \
       GLRO(dl_correct_cache_id) = envline[16] == '5' ? 2 : 3;		      \
     break;								      \
 
 /* Extra unsecure variables.  The names are all stuffed in a single
    string which means they have to be terminated with a '\0' explicitly.  */
 #define EXTRA_UNSECURE_ENVVARS \
+  "LD_LIBRARY_VERSION\0"						      \
   "LD_AOUT_LIBRARY_PATH\0"						      \
   "LD_AOUT_PRELOAD\0"
 
diff -puNr glibc-2.3.3-200406160000.orig/time/getdate.c glibc-2.3.3-200406160000/time/getdate.c
--- glibc-2.3.3-200406160000.orig/time/getdate.c	Sat Sep 27 21:59:47 2003
+++ glibc-2.3.3-200406160000/time/getdate.c	Sat Jan  8 09:16:53 2005
@@ -115,7 +115,7 @@ __getdate_r (const char *string, struct 
   struct stat64 st;
   int mday_ok = 0;
 
-  datemsk = getenv ("DATEMSK");
+  datemsk = __secure_getenv ("DATEMSK");
   if (datemsk == NULL || *datemsk == '\0')
     return 1;
 
diff -puNr glibc-2.3.3-200406160000.orig/time/tzfile.c glibc-2.3.3-200406160000/time/tzfile.c
--- glibc-2.3.3-200406160000.orig/time/tzfile.c	Wed Apr 14 17:40:33 2004
+++ glibc-2.3.3-200406160000/time/tzfile.c	Sat Jan  8 09:17:14 2005
@@ -132,7 +132,7 @@ __tzfile_read (const char *file, size_t 
       unsigned int len, tzdir_len;
       char *new, *tmp;
 
-      tzdir = getenv ("TZDIR");
+      tzdir = __secure_getenv ("TZDIR");
       if (tzdir == NULL || *tzdir == '\0')
 	{
 	  tzdir = default_tzdir;
diff -puNr glibc-2.3.3-200406160000.orig/time/tzset.c glibc-2.3.3-200406160000/time/tzset.c
--- glibc-2.3.3-200406160000.orig/time/tzset.c	Tue Feb 10 08:32:21 2004
+++ glibc-2.3.3-200406160000/time/tzset.c	Sat Jan  8 09:20:08 2005
@@ -157,8 +157,11 @@ tzset_internal (always)
     return;
   is_initialized = 1;
 
-  /* Examine the TZ environment variable.  */
-  tz = getenv ("TZ");
+  /* Examine the TZ environment variable.  This doesn't really have to be
+     a __locale_getenv() call as __tzfile_read() tries to only read files
+     found under a trusted directory, but this helps reduce the amount of
+     security-critical code.  */
+  tz = __locale_getenv ("TZ");
   if (tz == NULL)
     /* No user specification; use the site-wide default.  */
     tz = TZDEFAULT;
